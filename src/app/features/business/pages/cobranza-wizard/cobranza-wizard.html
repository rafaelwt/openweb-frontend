<main class="dark:bg-gray-900">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <!-- Loading overlay -->
    @if (loading()) {
      <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
        <app-loading size="lg" text="Procesando..."></app-loading>
      </div>
    }

    <!-- Cart wizard -->
    <div class="relative mx-auto max-w-250 py-5">
      <!-- Page title -->
      <app-wizard-header [cardTitle]="config()?.nombreServicio" (buttonClose)="goToHome()" />

      <!-- Wizard container -->
      <div class="relative overflow-visible rounded-lg bg-gray-100 p-4 shadow-md sm:p-8 dark:bg-gray-800">
        <!-- Progress bar + Badge -->
        <app-wizard-progress [currentStep]="currentStep()" [totalSteps]="totalSteps" [stepLabel]="stepLabel()" />

        <!-- Error alerts -->
        <app-error-alert [errors]="errors()" />

        <!-- Step-by-step content -->
        @switch (currentStep()) {
          <!-- STEP 1: Enter associate code -->
          @case (1) {
            <app-search-associate [form]="searchForm" [isLoading]="loading()" (search)="consultContracts()" />
          }

          <!-- STEP 2: Select contract -->
          @case (2) {
            <app-contract-selector [contracts]="contracts()" [selectedContract]="selectedContract()" [associateCode]="searchForm.get('codigoDeuda')?.value ?? ''" (selectContract)="selectContract($event)" />

            <app-wizard-nav [loading]="loading()" [canAdvance]="selectedContract() !== null" [showBack]="true" nextLabel="Consultar contrato" (backButton)="prevStep()" (nextButton)="confirmContract()" />
          }

          <!-- STEP 3: Debt table (Selection) -->
          @case (3) {
            <app-debt-table [outstandingDebts]="outstandingDebts()" [selectedDebts]="selectedDebts()" [currencyAbbreviation]="config()?.abreviacionMoneda ?? 'Bs'" [officialDocDescription]="config()?.descripcionDocOficial ?? 'Factura'" [associateCode]="searchForm.get('codigoDeuda')?.value ?? ''" [associateData]="associateData()" (toggleOne)="toggleDeuda($event.index, $event.checked)" (toggleAll)="toggleTodasDeudas($event)" />

            <app-wizard-nav [loading]="loading()" [canAdvance]="quantitySelectedDebts() > 0" [showBack]="true" nextLabel="Agregar al carrito" nextIcon="cart" (backButton)="prevStep()" (nextButton)="addToCart()" />
          }
        }
      </div>
    </div>
  </div>
</main>
