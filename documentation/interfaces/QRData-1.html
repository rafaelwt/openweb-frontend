<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>openweb-frontend documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>
          <script>
              // --- Iframe navigation tracking for Template Playground ---
              function sendCurrentUrlToParent() {
                  if (window.parent && window.parent !== window) {
                      window.parent.postMessage({
                          type: 'compodoc-iframe-navigate',
                          url: window.location.pathname + window.location.hash
                      }, '*');
                  }
              }
              window.addEventListener('hashchange', sendCurrentUrlToParent, false);
              window.addEventListener('popstate', sendCurrentUrlToParent, false);
              window.addEventListener('DOMContentLoaded', sendCurrentUrlToParent, false);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">openweb-frontend documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">

















<ol class="breadcrumb">
  <li class="breadcrumb-item">Interfaces</li>
  <li class="breadcrumb-item"
  >
  QRData</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/features/cart/pages/checkout-wizard/checkout-wizard.ts</code>
        </p>


            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>QR code data for payment display.</p>

            </p>


        <section data-compodoc="block-index">
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#qrImage" 
>
                                            qrImage
                                        </a>
                                </li>
                                <li>
                                        <a href="#validity" 
>
                                            validity
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section data-compodoc="block-properties">
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="qrImage"></a>
                                        <span class="name "><b>qrImage</b>
                                            <a href="#qrImage">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>qrImage:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="validity"></a>
                                        <span class="name "><b>validity</b>
                                            <a href="#validity">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>validity:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { NgOptimizedImage } from &#x27;@angular/common&#x27;;
import { ChangeDetectionStrategy, Component, OnInit, inject, signal, computed } from &#x27;@angular/core&#x27;;
import { Router } from &#x27;@angular/router&#x27;;
import { ReactiveFormsModule, FormBuilder, FormGroup, Validators } from &#x27;@angular/forms&#x27;;
import { from, EMPTY } from &#x27;rxjs&#x27;;
import { switchMap, tap, catchError, finalize } from &#x27;rxjs/operators&#x27;;
import { ApiService, CartService, FingerprintService, ErrorModalService } from &#x27;@core/services&#x27;;

import Decimal from &#x27;decimal.js-light&#x27;;

import { ItemCarrito } from &#x27;@models/index&#x27;;
import { WizardHeaderComponent } from &#x27;@shared/components/wizard-header/wizard-header&#x27;;
import { LoadingComponent } from &#x27;@shared/components/loading/loading&#x27;;
import { QrDisplayComponent } from &#x27;@shared/components/qr-display/qr-display&#x27;;

/**
 * QR code data for payment display.
 *
 * @internal
 */
interface QRData {
  validity: string;
  qrImage: string;
}

/**
 * Multi-step checkout wizard for payment processing.
 *
 * Handles the following workflow:
 * 1. **Step 1**: Cart review (view items, remove items, add more)
 * 2. **Step 2**: Payment method selection (QR Simple / QR con Comisión)
 * 3. **Step 3**: Billing information form (NIT validation, email, phone)
 * 4. **Step 4**: Payment processing (generate QR code via API)
 * 5. **Step 5**: QR code display (download, restart)
 *
 * @remarks
 * **Key features:**
 * - Integrates with CartService for cart state
 * - Uses FingerprintService for browser identification (fraud prevention)
 * - Validates NIT via API (special NITs: 99001, 99002, 99003)
 * - Generates QR codes for bank app payment
 * - Uses Decimal.js for precise currency calculations
 * - Handles API errors via ErrorModalService
 *
 * **Payment methods:**
 * - **QR Simple**: No commission, no billing required (uses default &quot;Control Tributario&quot;)
 * - **QR con Comisión**: Includes commission, requires valid NIT and billing data
 *
 * @selector app-checkout-wizard
 *
 * @see {@link CartService}
 * @see {@link FingerprintService}
 * @see {@link ApiService}
 */
@Component({
  selector: &#x27;app-checkout-wizard&#x27;,
  changeDetection: ChangeDetectionStrategy.OnPush,
  templateUrl: &#x27;./checkout-wizard.html&#x27;,
  imports: [ReactiveFormsModule, LoadingComponent, QrDisplayComponent, NgOptimizedImage, WizardHeaderComponent],
})
export class CheckoutWizardComponent implements OnInit {
  private readonly api &#x3D; inject(ApiService);
  private readonly cart &#x3D; inject(CartService);
  private readonly fingerprint &#x3D; inject(FingerprintService);
  private readonly router &#x3D; inject(Router);
  private readonly errorModal &#x3D; inject(ErrorModalService);
  private readonly fb &#x3D; inject(FormBuilder);

  // Configuration
  protected readonly processCardPayments &#x3D; true;
  protected readonly totalSteps &#x3D; 5;

  // Wizard status
  protected readonly currentStep &#x3D; signal(1);
  protected readonly loading &#x3D; signal(false);
  protected readonly errors &#x3D; signal&lt;string[]&gt;([]);

  // UI State
  protected readonly showCloseTooltip &#x3D; signal(false);
  protected readonly showDeleteTooltip &#x3D; signal&lt;number | null&gt;(null);
  protected readonly showExceptionNIT &#x3D; signal(false);

  // Items in cart
  protected readonly itemsCart &#x3D; signal&lt;ItemCarrito[]&gt;([]);

  /**
   * Computed signal with the currency abbreviation from the cart.
   *
   * @returns Currency abbreviation (e.g., &quot;Bs.&quot;, &quot;USD&quot;), defaults to &quot;Bs.&quot; if cart is empty
   *
   * @remarks
   * Uses CartService.cartCurrency() to get the currency from the first cart item.
   * All items in cart are guaranteed to have the same currency due to validation.
   */
  protected readonly currencySymbol &#x3D; computed(() &#x3D;&gt; {
    return this.cart.cartCurrency() ?? &#x27;Bs.&#x27;;
  });

  /**
   * Gets the plural form of officialDocDescription from the first cart item.
   * Defaults to &quot;facturas&quot; if no items in cart.
   * Simple pluralization by adding &quot;s&quot; to the end.
   *
   * @returns Plural form of document description (e.g., &quot;códigos de deudas&quot;, &quot;números de facturas&quot;)
   */
  protected getOfficialDocDescriptionPlural(): string {
    const firstItem &#x3D; this.itemsCart()[0];
    if (!firstItem?.descripcionDocOficial) {
      return &#x27;facturas&#x27;;
    }
    // Simple pluralization: add &quot;s&quot; at the end
    return firstItem.descripcionDocOficial.toLowerCase() + &#x27;s&#x27;;
  }

  // Reactive Form
  protected readonly form: FormGroup &#x3D; this.fb.group({
    medioPago: [&#x27;&#x27;],
    sinNombre: [&#x27;SI&#x27;],
    razonSocial: [&#x27;CONTROL TRIBUTARIO&#x27;],
    tipoDocumento: [5],
    documentoSIN: [&#x27;99002&#x27;],
    complementoSIN: [&#x27;&#x27;],
    excepcionNIT: [&#x27;false&#x27;],
    correoElectronico: [&#x27;&#x27;, [Validators.required, Validators.email]],
    numeroTelefono: [&#x27;&#x27;],
  });

  // Getters for form values
  protected get medioPago(): string {
    return this.form.get(&#x27;medioPago&#x27;)?.value ?? &#x27;&#x27;;
  }

  protected get sinNombre(): string {
    return this.form.get(&#x27;sinNombre&#x27;)?.value ?? &#x27;SI&#x27;;
  }

  protected get tipoDocumento(): number {
    return this.form.get(&#x27;tipoDocumento&#x27;)?.value ?? 5;
  }

  protected get razonSocial(): string {
    return this.form.get(&#x27;razonSocial&#x27;)?.value ?? &#x27;&#x27;;
  }

  protected get documentoSIN(): string {
    return this.form.get(&#x27;documentoSIN&#x27;)?.value ?? &#x27;&#x27;;
  }

  protected get complementoSIN(): string {
    return this.form.get(&#x27;complementoSIN&#x27;)?.value ?? &#x27;&#x27;;
  }

  protected get excepcionNIT(): string {
    return this.form.get(&#x27;excepcionNIT&#x27;)?.value ?? &#x27;false&#x27;;
  }

  protected get correoElectronico(): string {
    return this.form.get(&#x27;correoElectronico&#x27;)?.value ?? &#x27;&#x27;;
  }

  protected get numeroTelefono(): string {
    return this.form.get(&#x27;numeroTelefono&#x27;)?.value ?? &#x27;&#x27;;
  }

  // QR Data
  protected readonly qrData &#x3D; signal&lt;QRData&gt;({
    validity: &#x27;&#x27;,
    qrImage: &#x27;&#x27;,
  });

  // Computed
  protected readonly progress &#x3D; computed(() &#x3D;&gt; ((this.currentStep() - 1) / (this.totalSteps - 1)) * 100);

  protected stepLabel(): string {
    const medioPago &#x3D; this.form.get(&#x27;medioPago&#x27;)?.value;
    let label &#x3D; &#x27;&#x27;;

    switch (this.currentStep()) {
      case 1:
        label &#x3D; &#x27;CARRITO DE COMPRAS&#x27;;
        break;
      case 2:
        label &#x3D; &#x27;METODO DE PAGO&#x27;;
        break;
      case 3:
        label &#x3D; &#x27;INFORMACION&#x27;;
        break;
      case 4:
        label &#x3D; &#x27;RESUMEN FINAL&#x27;;
        break;
      case 5:
        label &#x3D; &#x27;PAGO&#x27;;
        break;
      default:
        label &#x3D; &#x27;PROCESANDO&#x27;;
    }

    if (medioPago &#x3D;&#x3D;&#x3D; &#x27;Q&#x27;) {
      return &#x60;${label} - QR&#x60;;
    } else if (medioPago &#x3D;&#x3D;&#x3D; &#x27;T&#x27;) {
      return &#x60;${label} - Tarjeta&#x60;;
    }
    return label;
  }

  protected readonly hasItems &#x3D; computed(() &#x3D;&gt; this.itemsCart().length &gt; 0);

  protected readonly totalServices &#x3D; computed(() &#x3D;&gt;
    this.itemsCart()
      .reduce((sum, item) &#x3D;&gt; sum.plus(item.totalServicio), new Decimal(0))
      .toDecimalPlaces(2)
      .toNumber(),
  );

  protected readonly totalCommissions &#x3D; computed(() &#x3D;&gt;
    this.itemsCart()
      .reduce((sum, item) &#x3D;&gt; sum.plus(item.totalComision), new Decimal(0))
      .toDecimalPlaces(2)
      .toNumber(),
  );

  protected readonly totalGeneral &#x3D; computed(() &#x3D;&gt; new Decimal(this.totalServices()).plus(this.totalCommissions()).toDecimalPlaces(2).toNumber());

  protected readonly hasCommissions &#x3D; computed(() &#x3D;&gt; this.totalCommissions() &gt; 0);

  protected readonly quantitySelectedDebts &#x3D; computed(() &#x3D;&gt; this.itemsCart().reduce((sum, item) &#x3D;&gt; sum + item.deudasSeleccionadas.length, 0));

  protected canAdvance(): boolean {
    const step &#x3D; this.currentStep();

    switch (step) {
      case 1:
        return this.hasItems();
      case 2:
        return this.form.get(&#x27;medioPago&#x27;)?.value !&#x3D;&#x3D; &#x27;&#x27;;
      case 3:
        return this.form.get(&#x27;correoElectronico&#x27;)?.value?.trim() !&#x3D;&#x3D; &#x27;&#x27;;
      case 4:
        return true;
      default:
        return false;
    }
  }

  ngOnInit(): void {
    this.loadCart();
  }

  private loadCart(): void {
    const items &#x3D; this.cart.items();
    this.itemsCart.set([...items]);

    // Pre-fill email from first item if available
    if (items.length &gt; 0 &amp;&amp; items[0].datosFacturacion?.correoElectronico) {
      this.form.patchValue({ correoElectronico: items[0].datosFacturacion.correoElectronico });
    }
  }

  // Remove item from cart
  removeItem(index: number): void {
    const items &#x3D; this.itemsCart();
    if (index &lt; 0 || index &gt;&#x3D; items.length) return;

    this.cart.removeItem(index);
    this.itemsCart.set([...this.cart.items()]);
  }

  // Add more services
  addMoreServices(): void {
    this.router.navigate([&#x27;/&#x27;]);
  }

  // Navigation - Continue payment from Step 1
  handleProcessPaymentClick(): void {
    if (this.processCardPayments) {
      this.nextStep();
    } else {
      this.form.patchValue({ medioPago: &#x27;Q&#x27; });
      this.nextStep();
    }
  }

  // Navigation - Next step
  handleNextStep(): void {
    // Validate current step
    const isValid &#x3D; this.validateCurrentStep();
    if (!isValid) return;

    // If we are in step 3 and there are commissions, validate NIT
    if (this.currentStep() &#x3D;&#x3D;&#x3D; 3 &amp;&amp; this.hasCommissions() &amp;&amp; this.form.get(&#x27;tipoDocumento&#x27;)?.value &#x3D;&#x3D;&#x3D; 5) {
      this.validateNIT();
      return; // validateNIT will call nextStep() if valid
    }

    this.nextStep();
  }

  private nextStep(): void {
    this.clearErrors();
    if (this.currentStep() &lt; this.totalSteps) {
      this.currentStep.update((s) &#x3D;&gt; s + 1);
      window.scrollTo({ top: 0, behavior: &#x27;smooth&#x27; });
    }
  }

  prevStep(): void {
    // Do not allow back navigation from step 5 (QR code generated)
    if (this.currentStep() &#x3D;&#x3D;&#x3D; 5) return;

    this.clearErrors();
    if (this.currentStep() &gt; 1) {
      this.currentStep.update((s) &#x3D;&gt; s - 1);
      window.scrollTo({ top: 0, behavior: &#x27;smooth&#x27; });
    }
  }

  // Validations
  private validateCurrentStep(): boolean {
    this.clearErrors();

    switch (this.currentStep()) {
      case 1:
        if (!this.hasItems()) {
          this.addError(&#x27;El carrito esta vacio&#x27;);
          return false;
        }
        return true;

      case 2:
        if (!this.form.get(&#x27;medioPago&#x27;)?.value) {
          this.addError(&#x27;Debe seleccionar un metodo de pago&#x27;);
          return false;
        }
        return true;

      case 3:
        return this.validateBillingShipping();

      case 4:
        return true;

      default:
        return true;
    }
  }

  private validateBillingShipping(): boolean {
    const email &#x3D; this.form.get(&#x27;correoElectronico&#x27;)?.value || &#x27;&#x27;;
    const companyName &#x3D; this.form.get(&#x27;razonSocial&#x27;)?.value || &#x27;&#x27;;
    const documentSIN &#x3D; this.form.get(&#x27;documentoSIN&#x27;)?.value || &#x27;&#x27;;

    // Validate email address
    if (!email.trim()) {
      this.addError(&#x27;El correo electronico es obligatorio&#x27;);
      return false;
    }

    const emailRegex &#x3D; /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      this.addError(&#x27;El correo electronico no tiene un formato valido&#x27;);
      return false;
    }

    // If there are fees, validate billing information.
    if (this.hasCommissions()) {
      if (!companyName.trim()) {
        this.addError(&#x27;La Razon Social es obligatoria&#x27;);
        return false;
      }

      if (!documentSIN.trim()) {
        this.addError(&#x27;El numero de documento es obligatorio&#x27;);
        return false;
      }
    }

    return true;
  }

  private validateNIT(): void {
    const documentType &#x3D; this.form.get(&#x27;tipoDocumento&#x27;)?.value;
    const documentSIN &#x3D; this.form.get(&#x27;documentoSIN&#x27;)?.value || &#x27;&#x27;;
    const exceptionNIT &#x3D; this.form.get(&#x27;excepcionNIT&#x27;)?.value;

    // Skip if it&#x27;s not a NIT - continue to the next step
    if (documentType !&#x3D;&#x3D; 5) {
      this.nextStep();
      return;
    }

    // Allow special NITs (Tax Control)
    if ([&#x27;99001&#x27;, &#x27;99002&#x27;, &#x27;99003&#x27;].includes(documentSIN)) {
      this.nextStep();
      return;
    }

    // If I already accept the exception
    if (exceptionNIT &#x3D;&#x3D;&#x3D; &#x27;true&#x27;) {
      this.nextStep();
      return;
    }

    this.loading.set(true);

    this.api.verifyNIT(documentSIN).subscribe({
      next: (response) &#x3D;&gt; {
        if (response?.success &amp;&amp; response.data?.estadoDocumento &#x3D;&#x3D;&#x3D; &#x27;true&#x27;) {
          this.loading.set(false);
          this.nextStep();
        } else {
          this.showExceptionNIT.set(true);
          this.addError(&#x27;NIT invalido. Confirme si se realiza Excepcion de registro con ese NIT&#x27;);
          this.loading.set(false);
          // If I already accepted the exception after the error, allow it to continue.
          if (this.form.get(&#x27;excepcionNIT&#x27;)?.value &#x3D;&#x3D;&#x3D; &#x27;true&#x27;) {
            this.nextStep();
          }
        }
      },
      error: (error: unknown) &#x3D;&gt; {
        this.handleApiError(error, &#x27;Error al validar NIT&#x27;);
        this.loading.set(false);
      },
    });
  }

  // Change unnamed mode
  changeBillingDataMode(unNamed: boolean): void {
    if (unNamed) {
      this.form.patchValue({
        sinNombre: &#x27;SI&#x27;,
        razonSocial: &#x27;CONTROL TRIBUTARIO&#x27;,
        tipoDocumento: 5,
        documentoSIN: &#x27;99002&#x27;,
        complementoSIN: &#x27;&#x27;,
        excepcionNIT: &#x27;false&#x27;,
      });
      this.showExceptionNIT.set(false);
    } else {
      this.form.patchValue({
        sinNombre: &#x27;NO&#x27;,
        razonSocial: &#x27;&#x27;,
        documentoSIN: &#x27;&#x27;,
        complementoSIN: &#x27;&#x27;,
      });
    }
  }

  // Process payment
  processPayment(): void {
    if (this.loading()) return;

    const formValue &#x3D; this.form.getRawValue();

    // Final validations
    if (!formValue.correoElectronico?.trim()) {
      this.addError(&#x27;Debe ingresar un correo electronico&#x27;);
      return;
    }

    if (formValue.medioPago !&#x3D;&#x3D; &#x27;Q&#x27;) {
      this.addError(&#x27;Metodo de pago no implementado&#x27;);
      return;
    }

    this.loading.set(true);

    // Chain of Observables without nesting
    from(this.fingerprint.generate())
      .pipe(
        switchMap((browserFingerprint) &#x3D;&gt; {
          const paymentData &#x3D; {
            medioPago: formValue.medioPago,
            itemsCarrito: this.itemsCart(),
            totalServicios: this.totalServices(),
            totalComisiones: this.totalCommissions(),
            totalGeneral: this.totalGeneral(),
            tipoDocumento: formValue.tipoDocumento,
            documentoSIN: formValue.documentoSIN,
            complementoSIN: formValue.complementoSIN,
            excepcionNIT: formValue.excepcionNIT &#x3D;&#x3D;&#x3D; &#x27;true&#x27; ? &#x27;1&#x27; : &#x27;0&#x27;,
            razonSocial: formValue.razonSocial,
            correoElectronico: formValue.correoElectronico,
            numeroTelefono: formValue.numeroTelefono || &#x27;0&#x27;,
            browserFingerprint,
          };
          return this.api.processPaymentCart(paymentData);
        }),
        tap((response) &#x3D;&gt; {
          if (response?.success &amp;&amp; response.data) {
            this.qrData.set({
              validity: response.data.validity,
              qrImage: response.data.qrImage,
            });
            this.cart.clearCart();
            this.currentStep.set(5);
            window.scrollTo({ top: 0, behavior: &#x27;smooth&#x27; });
          } else {
            this.addError(&#x27;Error al procesar el pago&#x27;);
          }
        }),
        catchError((error: unknown) &#x3D;&gt; {
          this.handleApiError(error, &#x27;Error al procesar el pago. Intente nuevamente.&#x27;);
          return EMPTY;
        }),
        finalize(() &#x3D;&gt; this.loading.set(false)),
      )
      .subscribe();
  }

  // Exit cart
  exitCart(): void {
    this.router.navigate([&#x27;/&#x27;]);
  }

  // Go to home
  goToHome(): void {
    this.router.navigate([&#x27;/&#x27;]);
  }

  // Helpers
  private addError(message: string): void {
    this.errors.update((errs) &#x3D;&gt; [...errs, message]);
  }

  private clearErrors(): void {
    this.errors.set([]);
  }

  formatNumber(value: number, decimals: number &#x3D; 2): string {
    return value.toLocaleString(&#x27;es-BO&#x27;, {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals,
    });
  }

  // Template helper for payment method selection (click handler)
  setPaymentMethod(value: string): void {
    this.form.patchValue({ medioPago: value });
  }

  // Template helper for NIT exception (radio button change)
  setExceptionNIT(value: string): void {
    this.form.patchValue({ excepcionNIT: value });
  }

  // API error handling
  private handleApiError(error: unknown, fallbackMessage: string): void {
    if (!this.errorModal.handleHttpError(error)) {
      this.addError(fallbackMessage);
    }
  }
}
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'QRData-1.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
